# v0.6.0 Block E Implementation Plan

**Block**: Sonnet Sprint 2
**Duration**: 2.5 weeks
**Model**: Claude Sonnet
**Status**: COMPLETE
**Last Updated**: 2026-02-16

---

## Overview

Block E completes the VibeVoice-ASR integration by adding the frontend UI, quality controls, and production packaging. This block builds on the completed Block C (research/design) and Block D (backend implementation).

**Dependencies**:
- ✅ Block C Complete: VibeVoice research, sidecar structure, OPUS design
- ✅ Block D Complete: Integration layer, model loading, sidecar mgmt, auto-processing

---

## Task Breakdown

### E19: Speaker-Diarized Transcript UI

**Complexity**: High
**Duration**: 3-4 days
**Dependencies**: D15, D18

**Goal**: Design and implement color-coded speaker segments in transcript view

**Deliverables**:

1. **Design**: Speaker color scheme (8 distinct colors for Speaker 0-7)
2. **UI Component**: Speaker segment rendering with:
   - Speaker label badge (e.g., "Speaker 1")
   - Color-coded left border
   - Timestamp display
   - Segment text
3. **Speaker Label Editing**: Click speaker badge to rename (e.g., "Speaker 1" → "John")
4. **Export Integration**: Include speaker attribution in TXT/MD/JSON exports

**Files**:
- `src/types.ts` — Add `SpeakerSegment` interface
- `src/history.ts` — Add `renderSpeakerSegments()` function
- `src/styles.css` — Speaker color scheme CSS variables
- `index.html` — Speaker segment HTML template

**Speaker Color Palette** (accessible, high contrast):
```css
--speaker-0: #3b82f6; /* Blue */
--speaker-1: #10b981; /* Green */
--speaker-2: #f59e0b; /* Amber */
--speaker-3: #ef4444; /* Red */
--speaker-4: #8b5cf6; /* Purple */
--speaker-5: #ec4899; /* Pink */
--speaker-6: #06b6d4; /* Cyan */
--speaker-7: #f97316; /* Orange */
```

**Success Criteria**:
- Speaker segments visually distinct with color coding
- Speaker labels editable and persist across sessions
- Export formats include speaker attribution

---

### E24: "Analyse" Button + Transcript View

**Complexity**: High
**Duration**: 3-4 days
**Dependencies**: E19, D18

**Goal**: Add UI trigger for VibeVoice analysis and display results

**Deliverables**:

1. **Analyse Button**: Add to System Audio panel toolbar
2. **Progress Indicator**: Show analysis status (loading spinner, progress %)
3. **Result Display**: Render speaker segments from sidecar response
4. **Error Handling**: Show user-friendly errors if analysis fails
5. **Result Storage**: Persist analysis results to avoid re-analysis

**UI Flow**:
```
1. User clicks "Analyse" button
2. Show loading spinner: "Analyzing audio..."
3. Backend:
   - Start sidecar if not running
   - Send /transcribe request with audio file path
   - Wait for response (timeout: 5 minutes)
4. Parse response (TranscriptionResponse with segments)
5. Render speaker segments in transcript view
6. Auto-generate chapters from speaker changes (optional)
7. Enable export with speaker attribution
```

**Files**:
- `src/dom-refs.ts` — Add `analyseButton`, `analyseSpinner`
- `src/event-listeners.ts` — Add analyse button click handler
- `src/history.ts` — Add `displayAnalysisResults()` function
- `index.html` — Add Analyse button to System Audio toolbar

**Success Criteria**:
- Analyse button triggers sidecar transcription
- Progress indicator shows during analysis
- Speaker segments render correctly
- Results persist across app restarts

---

### E26: Quality Preset Controls (FP16 vs INT8)

**Complexity**: Medium
**Duration**: 1-2 days
**Dependencies**: D21

**Goal**: UI for precision mode selection with VRAM/quality trade-off info

**Deliverables**:

1. **Settings Panel**: Add VibeVoice quality preset selector
2. **Preset Options**:
   - FP16 (Highest Quality) — 14-16 GB VRAM
   - INT8 (Balanced) — 7-8 GB VRAM
3. **Info Display**: Show VRAM requirements and quality comparison
4. **Persistence**: Save selection to settings
5. **Runtime Switching**: Model reloads when preset changes

**UI Design**:
```html
<details class="expander">
  <summary>VibeVoice-ASR Quality</summary>
  <div class="expander-body">
    <label class="field">
      <span class="field-label">Precision Mode</span>
      <select id="vibevoice-precision">
        <option value="fp16">FP16 — Highest Quality (14-16 GB VRAM)</option>
        <option value="int8">INT8 — Balanced (7-8 GB VRAM)</option>
      </select>
    </label>
    <span class="field-hint">
      FP16 provides best quality but requires more VRAM.
      INT8 is faster with slightly lower quality.
    </span>
  </div>
</details>
```

**Files**:
- `index.html` — Add quality preset UI to Settings tab
- `src/settings.ts` — Add `vibevoice_precision` rendering
- `src-tauri/src/sidecar.rs` — Pass precision to `/transcribe` endpoint

**Success Criteria**:
- UI clearly shows VRAM requirements
- Precision mode persists across sessions
- Model reloads when precision changes

---

### E27: Parallel Analysis Mode Toggle

**Complexity**: Medium
**Duration**: 1-2 days
**Dependencies**: D18

**Goal**: Optional simultaneous Whisper + VibeVoice mode with VRAM warning

**Deliverables**:

1. **Settings Toggle**: Enable/disable parallel mode
2. **VRAM Warning**: Show warning if total VRAM exceeds 16 GB
3. **Documentation**: Explain when to use parallel vs sequential mode
4. **Default**: Sequential mode (safer for most hardware)

**UI Design**:
```html
<label class="field toggle">
  <input id="parallel-mode" type="checkbox" />
  <span>Parallel Analysis Mode (Advanced)</span>
</label>
<span class="field-hint warning" style="display: none;" id="parallel-vram-warning">
  ⚠️ Parallel mode may exceed your VRAM capacity (Whisper: 2-4GB + VibeVoice FP16: 14-16GB = 16-20GB total).
  Consider using INT8 precision or sequential mode.
</span>
```

**VRAM Calculation**:
- Sequential: No VRAM conflict (Whisper and VibeVoice run separately)
- Parallel FP16: 2-4 GB (Whisper) + 14-16 GB (VibeVoice) = 16-20 GB
- Parallel INT8: 2-4 GB (Whisper) + 7-8 GB (VibeVoice) = 9-12 GB ✅ Safe for 16 GB

**Files**:
- `index.html` — Add parallel mode toggle
- `src/settings.ts` — Add VRAM warning logic
- `src-tauri/src/state.rs` — Add `parallel_mode` setting

**Success Criteria**:
- Toggle enables/disables parallel mode
- Warning shows if VRAM might be exceeded
- Documentation clearly explains trade-offs

---

### E28: Model Monitoring + User Notification

**Complexity**: Medium
**Duration**: 2-3 days
**Dependencies**: C14

**Goal**: Monitor VibeVoice model updates and notify user of new versions

**Deliverables**:

1. **Version Checking**: Periodic check for new model releases (weekly)
2. **Notification UI**: Toast notification when new version available
3. **Release Notes**: Show what's new in the update
4. **Update Flow**: Download new model, verify checksum, replace old version
5. **Rollback**: Keep backup of previous version

**Notification Example**:
```
┌─────────────────────────────────────────┐
│ New VibeVoice-ASR version available!    │
│                                          │
│ v2.1.0 — Improved speaker separation,   │
│ faster inference on RTX 40/50 series    │
│                                          │
│ [Update Now] [Remind Me Later] [Skip]   │
└─────────────────────────────────────────┘
```

**Version Check Sources**:
- GitHub Releases: `https://github.com/microsoft/VibeVoice/releases/latest`
- HuggingFace Model Hub: `https://huggingface.co/microsoft/vibevoice-asr-7b`

**Files**:
- `src/models.ts` — Add `checkVibeVoiceUpdates()` function
- `src/toast.ts` — Add update notification toast
- `src-tauri/src/models.rs` — Add version check logic

**Success Criteria**:
- Checks for updates weekly (configurable interval)
- Shows notification with release notes
- Update flow downloads and verifies new model
- Rollback available if update fails

---

### E29: PyInstaller Packaging for Sidecar

**Complexity**: Medium
**Duration**: 2-3 days
**Dependencies**: D18

**Goal**: Bundle FastAPI + VibeVoice into standalone `.exe` (no Python required)

**Deliverables**:

1. **PyInstaller Spec**: Create `sidecar.spec` for packaging
2. **Dependencies**: Bundle all required Python packages
3. **Model Files**: Include or download VibeVoice model separately
4. **Testing**: Verify on fresh Windows install (no Python)
5. **Installer Integration**: Bundle sidecar exe in main installer

**PyInstaller Command**:
```bash
cd sidecar/vibevoice-asr
pyinstaller --onefile --name vibevoice-asr-sidecar main.py
```

**Bundling Strategy**:
- **Sidecar Executable**: `vibevoice-asr-sidecar.exe` (~50-100 MB with dependencies)
- **Model Files**: Download on first run or bundle with installer (7-14 GB)
- **Installer**: Include sidecar exe in `resources/sidecar/`

**Files**:
- `sidecar/vibevoice-asr/sidecar.spec` — PyInstaller spec file
- `sidecar/vibevoice-asr/build-sidecar.bat` — Build automation script
- `tauri.conf.json` — Add sidecar exe to bundle resources

**Success Criteria**:
- Sidecar exe runs without Python installed
- All dependencies bundled correctly
- Model loading works from bundled exe
- Fresh Windows install test passes

---

### E30: E2E Test — Record to Analyse to Verify

**Complexity**: High
**Duration**: 2-3 days
**Dependencies**: E24, D25, E29

**Goal**: Full workflow integration test for VibeVoice pipeline

**Test Scenarios**:

1. **Basic Flow**:
   - Record 30 seconds of mic audio
   - Save as OPUS file
   - Click "Analyse" button
   - Verify sidecar starts and transcribes
   - Verify speaker segments render correctly
   - Verify auto-generated chapters

2. **VRAM Stress Test**:
   - Enable parallel mode (Whisper + VibeVoice)
   - Record simultaneous mic + system audio
   - Verify both models run without OOM error
   - Monitor VRAM usage (should stay under 16 GB with INT8)

3. **Error Recovery**:
   - Sidecar not running → auto-starts on analyse
   - Sidecar crashes → shows error toast, restarts
   - Invalid audio file → shows error, skips analysis
   - Network timeout → shows timeout error

4. **Export Verification**:
   - Export speaker-diarized transcript as TXT/MD/JSON
   - Verify speaker attribution in all formats
   - Verify chapter markers include speaker changes

**Files**:
- `src/__tests__/vibevoice-e2e.test.ts` — E2E test suite
- `src-tauri/tests/sidecar_integration.rs` — Rust integration tests

**Success Criteria**:
- All test scenarios pass
- VRAM usage within limits
- Error recovery works correctly
- Export formats valid

---

## Summary Checklist

- [x] E19: Speaker-diarized transcript UI (color-coded segments, editable labels)
- [x] E24: "Analyse" button + progress indicator + result display
- [x] E26: Quality preset controls (FP16 vs INT8 with VRAM info)
- [x] E27: Parallel mode toggle with VRAM warning
- [x] E28: Model monitoring + update notifications
- [x] E29: PyInstaller packaging for standalone sidecar exe
- [x] E30: E2E test — full workflow validation (22 tests)

---

## Acceptance Criteria

Block E is considered **complete** when:

1. ✅ Speaker-diarized transcripts render with color coding
2. ✅ Analyse button triggers VibeVoice analysis successfully
3. ✅ Quality presets (FP16/INT8) selectable and functional
4. ✅ Parallel mode toggle works with VRAM warning
5. ✅ Model update notifications shown to user
6. ✅ Sidecar packaged as standalone exe (no Python required)
7. ✅ E2E tests pass (record → analyse → export → verify)
8. ✅ Documentation updated (ARCHITECTURE.md, ROADMAP.md)
9. ✅ No regressions in existing features

---

## Next Steps After Block E

With Block E complete, v0.6.0 will be **feature-complete** for VibeVoice-ASR integration.

**Follow-up tasks (v0.6.0+)**:

- **E31-E34**: Parakeet ASR engine integration (see COMPETITOR_ANALYSIS_HANDY.md)
- **E35-E49**: Backend-aware Model Manager UI (see MODEL_MANAGER_BACKEND_CARDS.md)
- **v0.7.0**: AI Fallback Overhaul (multi-provider support)
- **v0.7.0+**: Quick Start Mode (first-run wizard, GPU auto-detection)

---

## References

- [VIBEVOICE_RESEARCH.md](VIBEVOICE_RESEARCH.md) — VibeVoice-ASR technical details
- [OPUS_PIPELINE_DESIGN.md](OPUS_PIPELINE_DESIGN.md) — OPUS encoding design
- [TASK_SCHEDULE.md](TASK_SCHEDULE.md) — Full task breakdown
- [COMPETITOR_ANALYSIS_HANDY.md](COMPETITOR_ANALYSIS_HANDY.md) — Parakeet integration opportunity
- [MODEL_MANAGER_BACKEND_CARDS.md](MODEL_MANAGER_BACKEND_CARDS.md) — Enhanced model selection UI
