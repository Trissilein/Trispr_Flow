# v0.7.0 Planning: AI Fallback Overhaul

**Phase**: Block F (Haiku Quick) - Requirements & UX Decision
**Duration**: 0.5 weeks
**Model**: Claude Haiku
**Status**: Planning
**Last Updated**: 2026-02-16

---

## Overview

v0.7.0 replaces the single-provider "Cloud Fallback" with a **multi-provider AI Fallback** system supporting Claude, OpenAI (ChatGPT), and Google Gemini. This enables users to:

1. Choose their preferred AI provider for post-processing refinement
2. Use multiple models from each provider (GPT-4, GPT-4o, Claude 3.5 Sonnet, Gemini 2.0, etc.)
3. Configure custom prompts for different use cases
4. Maintain local-first philosophy with optional cloud enhancement

**Key Difference from v0.6.0**:
- v0.6.0 focused on **local transcription quality** (VibeVoice diarization, OPUS encoding, chapters, topics)
- v0.7.0 focuses on **post-transcription enhancement** (AI-powered refinement via user's preferred provider)

---

## Current State (v0.6.0)

**Existing Cloud Fallback** (`src-tauri/src/cloud_fallback.rs`):
- Single endpoint: Anthropic Claude API
- Used as optional fallback for transcription refinement
- Settings: `cloud_fallback_enabled: bool`, `claude_api_key: string`
- Hard-coded system prompt for generalist refinement

**Pain Points**:
1. Single provider locks users into Anthropic
2. No model selection (always uses available Claude)
3. Hard-coded prompts (no customization)
4. Monolithic implementation (difficult to extend)
5. API key stored in plain settings.json (security concern)

---

## v0.7.0 Design Decisions (Task 39)

### Decision: UX Terminology

**Option 1: "AI Fallback"** (Recommended)
- **Pro**: Accurately describes behavior (falls back to AI if local refinement insufficient)
- **Pro**: Neutral terminology (not branded to one provider)
- **Pro**: Aligns with existing "Post-Processing" terminology
- **Con**: Less explicit about requiring API keys
- **Precedent**: Common in transcription tools (Google Docs, Otter.ai)

**Option 2: "AI Enhancement"**
- **Pro**: Proactive framing (enhancement, not fallback)
- **Con**: Less clear that it's optional
- **Con**: Suggests it always runs (misleading if disabled)

**Decision**: âœ… **Use "AI Fallback"** throughout UI/docs

### Decision: Settings Location

**Option 1: New "AI Fallback" Tab in Settings**
```
Settings Tabs:
- Capture Input
- System Audio
- Post-Processing
- Model Manager
- AI Fallback (NEW)
- UX/UI Adjustments
```
- **Pro**: Clear separation of concerns
- **Con**: Increases settings complexity
- **Con**: Less discoverable (buried in settings)

**Option 2: Expander in Post-Processing Panel**
```
Settings â†’ Post-Processing:
  â–¼ Post-Processing Rules (existing)
  â–¼ AI Fallback (NEW)
```
- **Pro**: Logical flow: local rules â†’ AI refinement
- **Pro**: Reduces settings tab clutter
- **Pro**: Clear dependency (rules apply before fallback)
- **Con**: May be confused with post-processing rules

**Decision**: âœ… **Add AI Fallback expander to Post-Processing panel**

### Decision: When Post-Processing Runs

**Sequence** (v0.7.0):
```
Raw Transcript
    â†“
[1] Local Post-Processing (existing)
    - Punctuation, capitalization, numbers
    - Custom vocabulary
    â†“
[2] AI Fallback (optional, if enabled)
    - User's selected provider + model
    - Custom prompt (if configured)
    â†“
Final Transcript (ready for export/paste)
```

**Rationale**:
- Local rules run first (fast, offline, always available)
- AI enhancement runs second (uses refined base text, not raw ASR)
- Both can be toggled independently in UI

---

## Provider Architecture Overview (Task 31)

### Supported Providers

| Provider | Models | Auth | Free Tier? | Best For |
|----------|--------|------|-----------|----------|
| **Anthropic Claude** | Claude 3.5 Sonnet, Opus, Haiku | API Key | Limited | Quality/reasoning |
| **OpenAI** | GPT-4o, GPT-4 Turbo, GPT-3.5 | API Key | No | Speed/cost balance |
| **Google Gemini** | Gemini 2.0 Pro, 1.5 Pro, 1.5 Flash | API Key | Limited | Speed/cost |

### Provider-Specific Limits

```rust
pub struct ProviderLimits {
    pub max_input_tokens: usize,
    pub max_output_tokens: usize,
    pub rate_limit_per_minute: usize,
    pub estimated_cost_per_1k_tokens: f64,
}

// Example:
// Claude: 200k input, 4k output, $3/$15 per 1M tokens
// GPT-4o: 128k input, 4k output, $5/$15 per 1M tokens
// Gemini: 1M input, 8k output, $0.075/$0.30 per 1M tokens
```

### API Key Security

**Current** (v0.6.0):
- Stored in plain text in `settings.json`
- Visible in file browser
- Potentially exposed in backups/sync

**v0.7.0 Approach**:
```
If available (Windows/macOS):
  â†’ Use system keyring/Credential Manager
  â†’ Encrypted storage

Fallback:
  â†’ settings.json (with security warning)
  â†’ User responsible for file permissions
```

---

## Settings Schema Design (Task 36)

### Before (v0.6.0)
```json
{
  "cloud_fallback_enabled": false,
  "claude_api_key": "sk-...",
  ...
}
```

### After (v0.7.0)
```json
{
  "ai_fallback": {
    "enabled": false,
    "provider": "claude",  // "claude" | "openai" | "gemini"
    "model": "claude-3-5-sonnet-20241022",
    "api_key_ref": "claude_key",  // Ref to system keyring
    "custom_prompt_enabled": false,
    "custom_prompt": "Polish the following transcript, fixing any transcription errors...",
    "use_default_prompt": true,
    "temperature": 0.3,
    "max_tokens": 4000
  },
  "providers": {
    "claude": {
      "api_key_stored": true,
      "available_models": ["claude-3-5-sonnet-20241022", "claude-3-opus-20250219"],
      "last_used_model": "claude-3-5-sonnet-20241022"
    },
    "openai": {
      "api_key_stored": false,
      "available_models": []
    },
    "gemini": {
      "api_key_stored": false,
      "available_models": []
    }
  },
  ...
}
```

### Settings Migration
```
v0.6.0 â†’ v0.7.0:
if (settings.cloud_fallback_enabled && settings.claude_api_key) {
  // Migrate to new schema
  settings.ai_fallback = {
    enabled: settings.cloud_fallback_enabled,
    provider: "claude",
    api_key_ref: "claude_key",
    use_default_prompt: true,
    ...
  }
  // Store key in system keyring (Windows/macOS)
  // Or keep in settings.json as fallback
}
```

---

## UI/UX Design (Task 37)

### Settings Panel: AI Fallback Expander

```
Settings â†’ Post-Processing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Post-Processing Rules                 â”‚
â”‚   â˜‘ Master toggle                       â”‚
â”‚   Language: English â–¼                   â”‚
â”‚   â˜‘ Punctuation enhancement             â”‚
â”‚   â˜‘ Capitalization                      â”‚
â”‚   â˜‘ Number normalization                â”‚
â”‚   Custom Vocabulary: [Add/Edit]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ AI Fallback (New)                     â”‚
â”‚   â˜‘ Enable AI refinement                â”‚
â”‚   Provider: [Claude â–¼ OpenAI Gemini]   â”‚
â”‚   Model: [claude-3-5-sonnet â–¼]         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ ğŸ”‘ API Key Setup                â”‚   â”‚
â”‚   â”‚ Provider: Claude                â”‚   â”‚
â”‚   â”‚ [Paste API key...]              â”‚   â”‚
â”‚   â”‚ [Test Connection] [Cancel] [OK] â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚   Advanced Options:                     â”‚
â”‚   â˜‘ Use custom prompt                   â”‚
â”‚   Temperature: [====â€¢===] 0.3           â”‚
â”‚   Max output tokens: [1000 â–¼]           â”‚
â”‚   [Edit Custom Prompt]                  â”‚
â”‚                                         â”‚
â”‚   ğŸ’¡ Est. cost per refinement: ~$0.01   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Custom Prompt Editor Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edit Custom Refinement Prompt          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Use Default] [Reset to Default]       â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ You are a professional           â”‚   â”‚
â”‚ â”‚ transcriptionist. The following  â”‚   â”‚
â”‚ â”‚ text is a raw transcript from    â”‚   â”‚
â”‚ â”‚ speech-to-text. Fix any errors,  â”‚   â”‚
â”‚ â”‚ improve punctuation, and ensure  â”‚   â”‚
â”‚ â”‚ proper formatting. Keep the same â”‚   â”‚
â”‚ â”‚ meaning and tone.                â”‚   â”‚
â”‚ â”‚                                  â”‚   â”‚
â”‚ â”‚ Transcript: {TRANSCRIPT}         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚ Available variables:                   â”‚
â”‚ â€¢ {TRANSCRIPT} â€” Raw transcript text   â”‚
â”‚ â€¢ {LANGUAGE} â€” Detected language       â”‚
â”‚ â€¢ {DURATION} â€” Audio duration (sec)    â”‚
â”‚                                        â”‚
â”‚ [Cancel] [Save]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Key Setup Dialog

**Windows**:
- Auto-save to Credential Manager
- Show: "Key stored securely in Windows Credential Manager"
- No display of actual key

**macOS**:
- Auto-save to Keychain
- Show: "Key stored securely in macOS Keychain"

**Linux/Fallback**:
- Store in settings.json with warning:
  âš ï¸ "API key stored in plain text. Restrict file permissions to 0600."

---

## Implementation Plan (Blocks G & H)

### Block G: Opus Sprint (Architecture & Data Model)

**Task 31**: Multi-provider architecture design
- Provider trait (common interface for all providers)
- Provider factory (instantiate based on selected provider)
- Request/response models (unified across providers)
- Error handling (provider-specific errors â†’ user-friendly messages)

**Task 36**: Settings migration + data model
- Migrate existing `cloud_fallback` settings
- Implement keyring integration (Windows/macOS)
- Settings validation (required fields, API key format validation)

**Task 37**: Config UI implementation
- AI Fallback expander in Post-Processing panel
- API key setup dialog with test connection
- Custom prompt editor modal
- Provider/model selector with available options

**Deliverables**: Architecture design doc, settings schema (JSON), UI mockups

### Block H: Sonnet Sprint (Provider Implementations)

**Task 32**: OpenAI integration
- OpenAI API client (gpt-4o, gpt-4-turbo, gpt-3.5-turbo)
- Streaming support for long refinements
- Error handling (rate limits, quota exceeded, invalid key)
- Token counting for cost estimation

**Task 33**: Claude (Anthropic) integration
- Claude API client (Claude 3.5 Sonnet, Opus, Haiku)
- Streaming support
- Error handling (overloaded, rate limits)
- Token counting for cost estimation

**Task 34**: Gemini integration
- Google Gemini API client (Gemini 2.0 Pro, 1.5 Pro, 1.5 Flash)
- Streaming support
- Error handling (quota, invalid key)
- Token counting

**Task 35**: Custom prompt strategy
- Default prompts per provider (optimized for each model's strengths)
- User-editable prompt with variable substitution
- Prompt validation (checks for {TRANSCRIPT} placeholder)
- Reset to default functionality

**Task 38**: E2E testing
- Record raw transcript â†’ refine with each provider â†’ verify output
- Error scenarios (invalid key, rate limit, timeout)
- Cost estimation accuracy

**Deliverables**: Working integrations, E2E tests, cost estimation feature

---

## Timeline

| Week | Block | Model | Tasks | Status |
|------|-------|-------|-------|--------|
| 1 | F | Haiku | 39 | ğŸ“‹ Planning (current) |
| 2-3 | G | Opus | 31, 36, 37 | ğŸ”µ Upcoming |
| 4-5 | H | Sonnet | 32-35, 38 | ğŸ”µ Upcoming |

**Total Duration**: 5 weeks (1 week planning + 4 weeks implementation)

---

## Success Criteria

âœ… **Block F Complete** when:
1. UX terminology decided ("AI Fallback")
2. Settings location chosen (expander in Post-Processing)
3. Execution sequence documented (local rules â†’ AI refinement)
4. Design decisions documented in DECISIONS.md

âœ… **Block G Complete** when:
1. Multi-provider architecture implemented
2. Settings schema migrated
3. UI components built and tested
4. Keyring integration working on Windows/macOS

âœ… **Block H Complete** when:
1. All three provider integrations working
2. Custom prompt editor functional
3. E2E tests passing (all providers, error cases)
4. Cost estimation feature implemented

âœ… **v0.7.0 Release** when:
1. All blocks complete
2. E2E tests passing
3. CHANGELOG updated
4. Documentation complete
5. No regressions in v0.6.0 features

---

## Known Risks

| Risk | Mitigation |
|------|-----------|
| API key security | Use system keyring where available, document file permissions |
| Cost estimation inaccuracy | Fetch live pricing data from providers, show confidence ranges |
| Provider API changes | Abstract provider interface, version lock dependencies |
| Rate limiting | Implement exponential backoff, queue refinement requests |
| Context window limits | Count tokens before sending, truncate transcript if needed |

---

## References

- Current: `src-tauri/src/cloud_fallback.rs`
- Migrate to: Multi-provider system with provider trait
- Settings: `src-tauri/src/state.rs`
- UI: `src/settings.ts`
- Tests: `src/tests/` (new E2E tests)

---

## Questions for Review

1. âœ… **Terminology**: "AI Fallback" approved?
2. âœ… **Settings location**: Expander in Post-Processing approved?
3. âœ… **Keyring integration**: Priority for Windows/macOS, fallback to file?
4. âœ… **Custom prompts**: Allow user editing, or restrict to predefined templates?
5. âš ï¸ **Cost tracking**: Show estimated cost per refinement in UI?
6. âš ï¸ **Streaming**: Show live refinement as it happens, or just final result?

---

**Next Step**: Block G implementation (Opus Sprint) â†’ Architecture design
