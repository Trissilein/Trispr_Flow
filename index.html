<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/styles.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap"
    />
    <title>Trispr Flow</title>
    <script type="module" src="/src/main.ts" defer></script>
  </head>
  <body>
    <div class="bg-noise"></div>
    <div id="toast-container" class="toast-container"
         role="region"
         aria-live="polite"
         aria-label="Notifications"></div>
    <div id="recording-announcement" class="sr-only"
         role="status"
         aria-live="assertive"
         aria-atomic="true"></div>
    <div id="transcribe-announcement" class="sr-only"
         role="status"
         aria-live="polite"
         aria-atomic="true"></div>
    <main class="app">
      <header class="hero" style="--delay: 0.05s">
        <div>
          <div class="badge" id="dictation-badge">Offline dictation</div>
          <h1>Trispr Flow <span id="app-version" class="app-version"></span></h1>
          <p class="subtitle">
            GPU-first voice capture and transcription for English + Deutsch, with
            a privacy-first local pipeline and optional AI fallback refinement.
          </p>
          <div class="status" role="status" aria-live="polite">
            <div class="status-item">
              <span id="recording-pill" class="status-pill status-pill--disabled">Recording</span>
              <span class="status-dot" id="status-dot" data-state="idle"
                    aria-label="Recording status: idle"></span>
              <span id="status-label" class="status-label">Recording: Idle</span>
            </div>
            <div class="status-item">
              <span id="transcribe-pill" class="status-pill status-pill--disabled">Transcribing</span>
              <span class="status-dot" id="transcribe-dot" data-state="idle"
                    aria-label="Transcribing status: idle"></span>
              <span id="transcribe-label" class="status-label">Transcribing: Idle</span>
            </div>
            <span id="status-message" class="status-message" role="alert"></span>
          </div>
        </div>
        <div class="panel hero-card">
          <div class="hero-item">
            <span class="hero-label">AI refinement <span id="cloud-check" class="hero-check">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </span></span>
            <span id="cloud-state" class="hero-value">No</span>
            <span id="cloud-detail" class="hero-value truncate-two">Offline ‚Ä¢ No model selected</span>
          </div>
          <div class="hero-item">
            <span class="hero-label">Input Transcription</span>
            <span id="device-state" class="hero-value truncate-two">Default (System)</span>
          </div>
          <div class="hero-item">
            <span class="hero-label">Capture Mode</span>
            <span id="mode-state" class="hero-value">PTT</span>
          </div>
          <div class="hero-item">
            <span class="hero-label">System Audio Transcription</span>
            <span id="transcribe-status-pill" class="status-pill status-pill--disabled">Disabled</span>
            <span id="output-device-state" class="hero-value truncate-two">Default (System)</span>
          </div>
          <div class="hero-item">
            <span class="hero-label">Model</span>
            <span id="model-state" class="hero-value truncate-two">‚Äî</span>
          </div>
          <div class="hero-item">
            <span class="hero-label">AI Model</span>
            <span id="ai-model-state" class="hero-value truncate-two">‚Äî</span>
          </div>
        </div>
      </header>

      <!-- Main navigation tabs -->
      <div class="main-tabs" role="tablist" aria-label="Main navigation">
        <button id="tab-btn-transcription" class="main-tab-btn active" role="tab" aria-selected="true" aria-controls="tab-transcription">
          Transcription
        </button>
        <button id="tab-btn-settings" class="main-tab-btn" role="tab" aria-selected="false" aria-controls="tab-settings">
          Settings
        </button>
        <button id="tab-btn-ai-refinement" class="main-tab-btn" role="tab" aria-selected="false" aria-controls="tab-ai-refinement">
          AI Refinement
        </button>
      </div>

      <div class="layout-grid">
        <!-- Transcription Tab -->
        <div id="tab-transcription" class="main-tab-content active" role="tabpanel" aria-labelledby="tab-btn-transcription">
        <section class="panel output-panel" data-panel="transcription" data-default-collapsed="false" style="--delay: 0.12s">
          <div class="panel-header">
            <div class="panel-title">
              <h2>Transcription</h2>
              <p>Latest transcripts. Switch between input and system audio.</p>
            </div>
            <div class="panel-actions">
              <button class="panel-collapse-btn"
                      data-panel-collapse="transcription"
                      title="Collapse"
                      aria-expanded="true"
                      aria-controls="transcription-panel-body"
                      aria-label="Collapse transcription panel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body" id="transcription-panel-body">
            <div class="history-toolbar">
              <div class="history-tabs">
                <button id="history-tab-mic" class="history-tab active" title="Show microphone input transcripts">Input</button>
                <button id="history-tab-system" class="history-tab" title="Show system audio transcripts">System Audio</button>
                <button id="history-tab-conversation" class="history-tab" title="Show combined conversation view (mic + system audio)">Conv</button>
              </div>
              <div class="history-toolbar-actions">
                <div id="history-alias-controls" class="history-alias-controls">
                  <label class="history-alias-field" for="history-alias-mic-input">
                    <span class="history-alias-label">Input</span>
                    <input
                      id="history-alias-mic-input"
                      class="history-alias-input"
                      type="text"
                      maxlength="32"
                      placeholder="Input"
                      title="Display name for your microphone in the Conversation view"
                      aria-label="Conversation name for input source"
                    />
                  </label>
                  <label class="history-alias-field" for="history-alias-system-input">
                    <span class="history-alias-label">System</span>
                    <input
                      id="history-alias-system-input"
                      class="history-alias-input"
                      type="text"
                      maxlength="32"
                      placeholder="System audio"
                      title="Display name for system audio in the Conversation view"
                      aria-label="Conversation name for system audio source"
                    />
                  </label>
                </div>
                <button id="history-copy-conversation" class="ghost-btn" title="Copy the full conversation to clipboard">Copy</button>
                <button id="analyse-button" class="ghost-btn" title="Analyse module coming soon">
                  Analyse
                </button>
                <div class="export-controls">
                  <select id="export-format" class="export-format" title="Select export format">
                    <option value="txt">TXT</option>
                    <option value="md">Markdown</option>
                    <option value="json">JSON</option>
                  </select>
                  <button id="history-export" class="ghost-btn" title="Export transcript">Export</button>
                </div>
                <div id="conversation-font-controls" class="font-controls" title="Adjust transcript font size for the active tab">
                  <span class="font-label">Font</span>
                  <input id="conversation-font-size" type="range" min="12" max="24" step="1"
                         title="Font size for transcript text"
                         aria-valuemin="12"
                         aria-valuemax="24"
                         aria-valuenow="14"
                         aria-label="Transcript font size"
                         aria-describedby="conversation-font-size-value" />
                  <span id="conversation-font-size-value" class="font-value" aria-live="polite">14px</span>
                </div>
              </div>
            </div>
            <div class="history-search-container">
              <input id="history-search" type="text" class="history-search-input" placeholder="Search transcripts..."
                     title="Filter transcripts by keyword" />
              <button id="history-search-clear" class="history-search-clear" title="Clear search">√ó</button>
            </div>
            <div id="chapters-container" class="chapters-container" style="display: none;">
              <div class="chapters-header">
                <span class="chapters-title">üìë Chapters</span>
                <div class="chapters-controls">
                  <select id="chapter-method" class="chapter-method-select" title="Chapter generation method">
                    <option value="silence">Silence-based</option>
                    <option value="time">Time-based (5min)</option>
                    <option value="hybrid">Hybrid</option>
                  </select>
                  <button id="chapters-toggle" class="ghost-btn" title="Hide chapters">Hide</button>
                </div>
              </div>
              <div id="chapters-list" class="chapters-list"></div>
            </div>
            <div id="history-list" class="history-list"></div>
          </div>
        </section>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="main-tab-content" role="tabpanel" aria-labelledby="tab-btn-settings">
        <section class="panel capture-panel" data-panel="capture" data-default-collapsed="true" data-panel-group="input-source" style="--delay: 0.16s">
          <div class="panel-header">
            <div class="panel-title">
              <h2>Capture Input</h2>
              <p>Hotkeys, input device, recording mode.</p>
            </div>
            <div class="panel-actions">
              <button class="panel-collapse-btn"
                      data-panel-collapse="capture"
                      title="Collapse"
                      aria-expanded="true"
                      aria-controls="capture-panel-body"
                      aria-label="Collapse capture input panel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body" id="capture-panel-body">
            <div class="panel-grid">
            <div class="field toggle-with-hint span-2">
              <label class="toggle-row">
                <span class="field-label">Enable input capture</span>
                <input id="capture-enabled-toggle" type="checkbox" title="Enable voice capture and hotkeys" />
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </label>
              <span class="toggle-hint">When disabled, input capture and hotkeys are inactive</span>
            </div>
            <label class="field">
              <span class="field-label">Input device</span>
              <select id="device-select" title="Microphone or audio input device to use for recording"></select>
            </label>
            <label class="field">
              <span class="field-label">Capture mode</span>
              <select id="mode-select" title="Capture mode: Push-to-Talk (hold key) or Voice-Activated">
                <option value="ptt">Push-to-talk (PTT)</option>
                <option value="vad">Voice Activation</option>
              </select>
            </label>
            <label class="field">
              <span class="field-label">Language</span>
              <select id="language-select" title="Transcription language (or Auto-detect)">
                <option value="auto">Auto-detect</option>
                <option value="en">English</option>
                <option value="de">Deutsch (German)</option>
                <option value="fr">Fran√ßais (French)</option>
                <option value="es">Espa√±ol (Spanish)</option>
                <option value="it">Italiano (Italian)</option>
                <option value="pt">Portugu√™s (Portuguese)</option>
                <option value="nl">Nederlands (Dutch)</option>
                <option value="pl">Polski (Polish)</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π (Russian)</option>
                <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                <option value="ko">ÌïúÍµ≠Ïñ¥ (Korean)</option>
                <option value="zh">‰∏≠Êñá (Chinese)</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
                <option value="tr">T√ºrk√ße (Turkish)</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
              </select>
            </label>
            <label class="field toggle">
              <div class="toggle-row">
                <span class="field-label">Pin language</span>
                <input id="language-pinned-toggle" type="checkbox" title="Lock to selected language instead of auto-detecting" />
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </div>
              <span class="toggle-hint">Force selected language instead of auto-detection</span>
            </label>
            <div id="hotkeys-block" class="field-group">
              <div class="field hotkey-field">
                <span class="field-label">PTT hotkey (hold)</span>
                <div class="hotkey-input-group">
                  <input id="ptt-hotkey" type="text" placeholder="CommandOrControl+Shift+Space" readonly title="Current PTT hotkey ‚Äî click Record to change" />
                  <button id="ptt-hotkey-record" class="hotkey-record-btn" title="Click to record hotkey">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" />
                    </svg>
                    Record
                  </button>
                </div>
                <span id="ptt-hotkey-status" class="hotkey-status"
                      role="status"
                      aria-live="polite"></span>
              </div>
              <div class="field hotkey-field">
                <span class="field-label">Toggle hotkey (click)</span>
                <div class="hotkey-input-group">
                  <input id="toggle-hotkey" type="text" placeholder="CommandOrControl+Shift+M" readonly title="Current toggle hotkey ‚Äî click Record to change" />
                  <button id="toggle-hotkey-record" class="hotkey-record-btn" title="Click to record hotkey">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" />
                    </svg>
                    Record
                  </button>
                </div>
                <span id="toggle-hotkey-status" class="hotkey-status"
                      role="status"
                      aria-live="polite"></span>
              </div>
              <label class="field toggle">
                <span class="field-label">Use Voice Activation in PTT</span>
                <input id="ptt-use-vad-toggle" type="checkbox" title="Detect speech automatically while holding the PTT key" />
                <span class="toggle-hint">Only record when audio exceeds threshold, even while holding PTT key</span>
              </label>
            </div>
            <div id="vad-block" class="field-group hidden">
              <label class="field range">
                <span class="field-label">Voice Activation threshold</span>
                <div class="range-row">
                  <input id="vad-threshold" type="range" min="-60" max="0" step="1"
                         title="Minimum volume level to start recording (dB)"
                         aria-valuemin="-60"
                         aria-valuemax="0"
                         aria-valuenow="-34"
                         aria-label="Voice activation threshold"
                         aria-describedby="vad-threshold-value" />
                  <span id="vad-threshold-value" class="range-value" aria-live="polite">-34 dB</span>
                </div>
              </label>
              <label class="field range">
                <span class="field-label">Silence grace</span>
                <div class="range-row">
                  <input id="vad-silence" type="range" min="200" max="4000" step="50"
                         title="How long silence must last before recording stops (ms)"
                         aria-valuemin="200"
                         aria-valuemax="4000"
                         aria-valuenow="700"
                         aria-label="Voice activation silence grace period"
                         aria-describedby="vad-silence-value" />
                  <span id="vad-silence-value" class="range-value" aria-live="polite">700 ms</span>
                </div>
              </label>
              <div class="field">
                <span class="field-label">Input level <span id="vad-level-dbm" class="dbm-value">-‚àû dB</span></span>
                <div class="vad-meter-container">
                  <div id="vad-meter" class="vad-meter">
                    <div id="vad-meter-fill" class="vad-meter-fill"></div>
                    <div id="vad-marker-start" class="vad-marker vad-marker-start" title="Start threshold"></div>
                    <div id="vad-marker-sustain" class="vad-marker vad-marker-sustain" title="Sustain threshold (dynamic)"></div>
                  </div>
                  <div class="vad-meter-scale">
                    <span data-db="-60">-60</span>
                    <span data-db="-40">-40</span>
                    <span data-db="-20">-20</span>
                    <span data-db="0">0 dB</span>
                  </div>
                </div>
              </div>
              <label class="field range span-2">
                <span class="field-label">Mic input gain</span>
                <div class="range-row">
                  <input id="mic-gain" type="range" min="-30" max="30" step="1"
                         title="Boost or reduce microphone input level (dB)"
                         aria-valuemin="-30"
                         aria-valuemax="30"
                         aria-valuenow="0"
                       aria-label="Input gain"
                         aria-describedby="mic-gain-value" />
                  <span id="mic-gain-value" class="range-value" aria-live="polite">+0 dB</span>
                </div>
              </label>
            </div>
            <details class="expander span-2">
              <summary>Dumping</summary>
              <div class="expander-content">
                <div class="field toggle">
                  <label class="toggle-row">
                    <span class="field-label">Auto-save mic continuous audio</span>
                    <input id="auto-save-mic-audio-toggle" type="checkbox" title="Save Toggle/VAD mic recordings as OPUS files for later analysis" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Save mic Toggle/VAD sessions as OPUS.</span>
                </div>
                <div class="field toggle span-2">
                  <label class="toggle-row">
                    <span class="field-label">Mic continuous override</span>
                    <input id="continuous-mic-override-toggle" type="checkbox" title="Use custom timing settings for mic instead of global defaults" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Use source-specific dump timings for mic Toggle/VAD.</span>
                </div>
                <label class="field range span-2">
                  <span class="field-label">Mic soft flush</span>
                  <div class="range-row">
                    <input id="continuous-mic-soft-flush" type="range" min="4000" max="30000" step="500"
                           title="Flush mic buffer after this much silence (seconds)"
                           aria-valuemin="4000"
                           aria-valuemax="30000"
                           aria-valuenow="10000"
                           aria-label="Mic soft flush"
                           aria-describedby="continuous-mic-soft-flush-value" />
                    <span id="continuous-mic-soft-flush-value" class="range-value" aria-live="polite">10s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Mic silence flush</span>
                  <div class="range-row">
                    <input id="continuous-mic-silence-flush" type="range" min="300" max="5000" step="100"
                           title="Force a flush after this silence duration (seconds)"
                           aria-valuemin="300"
                           aria-valuemax="5000"
                           aria-valuenow="1200"
                           aria-label="Mic silence flush"
                           aria-describedby="continuous-mic-silence-flush-value" />
                    <span id="continuous-mic-silence-flush-value" class="range-value" aria-live="polite">1.2s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Mic hard cut</span>
                  <div class="range-row">
                    <input id="continuous-mic-hard-cut" type="range" min="15000" max="120000" step="1000"
                           title="Maximum mic segment length before a forced split (seconds)"
                           aria-valuemin="15000"
                           aria-valuemax="120000"
                           aria-valuenow="45000"
                           aria-label="Mic hard cut"
                           aria-describedby="continuous-mic-hard-cut-value" />
                    <span id="continuous-mic-hard-cut-value" class="range-value" aria-live="polite">45s</span>
                  </div>
                </label>
              </div>
            </details>
            <details class="expander span-2">
              <summary>Advanced</summary>
              <div class="expander-content">
                <div class="field toggle span-2">
                  <div class="toggle-row">
                    <span class="field-label">Hallucination filter</span>
                    <input id="hallucination-filter-toggle" type="checkbox" title="Drop low-confidence short transcripts caused by background noise" />
                    <span class="toggle-track">
                      <span class="toggle-thumb"></span>
                    </span>
                  </div>
                  <span class="toggle-hint">Filter out low-energy noise and common hallucinations</span>
                </div>
                <div class="field toggle span-2">
                  <div class="toggle-row">
                    <span class="field-label">Activation words</span>
                    <input id="activation-words-toggle" type="checkbox" title="Only keep transcripts that contain one of the trigger words" />
                    <span class="toggle-track">
                      <span class="toggle-thumb"></span>
                    </span>
                  </div>
                  <span class="toggle-hint">Only process transcripts containing trigger words</span>
                </div>
                <div id="activation-words-config" class="field span-2 hidden">
                  <label class="field-label">Word list (one per line)</label>
                  <textarea id="activation-words-list" rows="4"
                    placeholder="computer&#10;hey assistant"
                    title="One trigger word or phrase per line ‚Äî only matching transcripts are kept"
                    class="activation-words-textarea"></textarea>
                  <span class="field-hint">Case-insensitive word matching</span>
                </div>
                <label class="field toggle span-2">
                  <span class="field-label">Audio cues</span>
                  <input id="audio-cues-toggle" type="checkbox" title="Play a sound when recording starts or stops" />
                  <span class="toggle-track">
                    <span class="toggle-thumb"></span>
                  </span>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Audio cue volume</span>
                  <div class="range-row">
                    <input id="audio-cues-volume" type="range" min="0" max="100" step="1"
                           title="Volume of start/stop audio cue sounds"
                           aria-valuemin="0"
                           aria-valuemax="100"
                           aria-valuenow="30"
                           aria-label="Audio cue volume"
                           aria-describedby="audio-cues-volume-value" />
                    <span id="audio-cues-volume-value" class="range-value" aria-live="polite">30%</span>
                  </div>
                </label>
              </div>
            </details>
            </div>
          </div>
        </section>

        <section class="panel transcribe-panel" data-panel="system" data-default-collapsed="true" data-panel-group="input-source" style="--delay: 0.18s">
          <div class="panel-header">
            <div class="panel-title">
              <h2>System Audio Capture</h2>
              <p>System audio device, transcribe hotkey, detection settings.</p>
            </div>
            <div class="panel-actions">
              <button class="panel-collapse-btn"
                      data-panel-collapse="system"
                      title="Collapse"
                      aria-expanded="true"
                      aria-controls="system-panel-body"
                      aria-label="Collapse system audio capture panel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body" id="system-panel-body">
          <div class="panel-grid">
            <div class="field toggle-with-hint span-2">
              <label class="toggle-row">
                <span class="field-label">Enable system audio transcription</span>
                <input id="transcribe-enabled-toggle" type="checkbox" title="Capture and transcribe system audio (speakers/loopback)" />
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </label>
              <span class="toggle-hint">When disabled, system audio monitoring and transcription are inactive</span>
            </div>
            <label class="field">
              <span class="field-label">Capture device</span>
              <select id="transcribe-device-select" title="System audio output device to capture (loopback)"></select>
            </label>
            <div class="field hotkey-field span-2">
              <span class="field-label">Transcribe hotkey</span>
              <div class="hotkey-input-group">
                <input id="transcribe-hotkey" type="text" placeholder="CommandOrControl+Shift+T" readonly title="Current system audio transcription hotkey ‚Äî click Record to change" />
                <button id="transcribe-hotkey-record" class="hotkey-record-btn" title="Click to record hotkey">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" />
                  </svg>
                  Record
                </button>
              </div>
              <span id="transcribe-hotkey-status" class="hotkey-status"
                    role="status"
                    aria-live="polite"></span>
            </div>
            <label class="field toggle">
              <span class="field-label">Voice activation mode</span>
              <input id="transcribe-vad-toggle" type="checkbox" title="Only transcribe when speech is detected (voice-activated)" />
              <span class="toggle-track">
                <span class="toggle-thumb"></span>
              </span>
            </label>
            <label class="field toggle">
              <span class="field-label">Intelligent auto-dumping</span>
              <input id="continuous-dump-enabled-toggle" type="checkbox" title="Automatically split and flush long system audio recordings" />
              <span class="toggle-track">
                <span class="toggle-thumb"></span>
              </span>
            </label>
            <label class="field span-2">
              <span class="field-label">Auto-dump profile</span>
              <select id="continuous-dump-profile" title="Pre-set timing profile for continuous audio splitting">
                <option value="balanced">Balanced (recommended)</option>
                <option value="low_latency">Low latency</option>
                <option value="high_quality">High quality</option>
              </select>
              <span class="field-hint">Hybrid rules: silence + soft interval + hard cut.</span>
            </label>
            <label class="field range" id="transcribe-vad-threshold-field">
              <span class="field-label">Voice Activation threshold</span>
              <div class="range-row">
                <input id="transcribe-vad-threshold" type="range" min="-60" max="0" step="1"
                       title="Minimum volume to trigger system audio transcription (dB)"
                       aria-valuemin="-60"
                       aria-valuemax="0"
                       aria-valuenow="-28"
                       aria-label="System audio voice activation threshold"
                       aria-describedby="transcribe-vad-threshold-value" />
                <span id="transcribe-vad-threshold-value" class="range-value" aria-live="polite">-28 dB</span>
              </div>
            </label>
            <label class="field range" id="transcribe-vad-silence-field">
              <span class="field-label">Silence grace</span>
              <div class="range-row">
                <input id="transcribe-vad-silence" type="range" min="200" max="5000" step="100"
                       title="Silence duration before system audio recording stops (ms)"
                       aria-valuemin="200"
                       aria-valuemax="5000"
                       aria-valuenow="900"
                       aria-label="System audio silence grace period"
                       aria-describedby="transcribe-vad-silence-value" />
                <span id="transcribe-vad-silence-value" class="range-value" aria-live="polite">0.9s</span>
              </div>
            </label>
            <div class="field span-2">
              <span class="field-label">System audio level</span>
              <div class="meter-stack">
                <div class="meter-row">
                  <div id="transcribe-meter" class="vad-meter">
                    <div id="transcribe-meter-fill" class="vad-meter-fill"></div>
                    <div id="transcribe-meter-threshold" class="meter-threshold-marker"></div>
                  </div>
                  <span id="transcribe-meter-db" class="meter-db">-60 dB</span>
                </div>
                <div class="meter-scale">
                  <span>-60</span>
                  <span>-40</span>
                  <span>-20</span>
                  <span>0 dB</span>
                </div>
                <div class="meter-threshold-label" id="transcribe-threshold-label">
                  Threshold: <span id="transcribe-threshold-db">-60 dB</span>
                </div>
              </div>
            </div>
            <label class="field range span-2" id="transcribe-gain-field">
              <span class="field-label">Input gain</span>
              <div class="range-row">
                <input id="transcribe-gain" type="range" min="-30" max="30" step="1"
                       title="Boost or reduce system audio input level (dB)"
                       aria-valuemin="-30"
                       aria-valuemax="30"
                       aria-valuenow="0"
                       aria-label="System audio input gain"
                       aria-describedby="transcribe-gain-value" />
                <span id="transcribe-gain-value" class="range-value" aria-live="polite">+0 dB</span>
              </div>
            </label>
            <label class="field range" id="transcribe-batch-field">
              <span class="field-label">Soft flush target</span>
              <span class="field-hint">Preferred interval for adaptive flush when no clear silence cut appears.</span>
              <div class="range-row">
                <input id="transcribe-batch-interval" type="range" min="4000" max="15000" step="1000"
                       title="Target segment length for system audio (seconds)"
                       aria-valuemin="4000"
                       aria-valuemax="15000"
                       aria-valuenow="8000"
                       aria-label="System audio chunk interval"
                       aria-describedby="transcribe-batch-value" />
                <span id="transcribe-batch-value" class="range-value" aria-live="polite">8s</span>
              </div>
            </label>
            <label class="field range" id="transcribe-overlap-field">
              <span class="field-label">Context pre-roll</span>
              <span class="field-hint">Leading context kept for adaptive segment starts.</span>
              <div class="range-row">
                <input id="transcribe-chunk-overlap" type="range" min="0" max="3000" step="250"
                       title="Audio pre-roll added before each system audio chunk (seconds)"
                       aria-valuemin="0"
                       aria-valuemax="3000"
                       aria-valuenow="1000"
                       aria-label="System audio chunk overlap duration"
                       aria-describedby="transcribe-overlap-value" />
                <span id="transcribe-overlap-value" class="range-value" aria-live="polite">1s</span>
              </div>
            </label>
            <details class="expander span-2">
              <summary>Advanced</summary>
              <div class="expander-content">
                <div class="field toggle">
                  <label class="toggle-row">
                    <span class="field-label">Save recordings as OPUS</span>
                    <input id="opus-enabled-toggle" type="checkbox" title="Auto-save system audio recordings longer than 10 s as OPUS" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Auto-save recordings longer than 10s.</span>
                </div>
                <label class="field">
                  <span class="field-label">OPUS bitrate</span>
                  <select id="opus-bitrate-select" title="Audio quality for saved OPUS recordings">
                    <option value="32">32 kbps (smallest)</option>
                    <option value="64">64 kbps (recommended)</option>
                    <option value="96">96 kbps (high quality)</option>
                    <option value="128">128 kbps (best quality)</option>
                  </select>
                  <span class="field-hint">Higher bitrate = better audio quality but larger files</span>
                </label>
                <div class="field toggle">
                  <label class="toggle-row">
                    <span class="field-label">Auto-save system audio</span>
                    <input id="auto-save-system-audio-toggle" type="checkbox" title="Save system audio chunks as OPUS files for later analysis" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Save system audio chunks as OPUS.</span>
                </div>
                <label class="field range span-2">
                  <span class="field-label">Hard cut limit</span>
                  <div class="range-row">
                    <input id="continuous-hard-cut" type="range" min="15000" max="120000" step="1000"
                           title="Maximum system audio segment length (seconds)"
                           aria-valuemin="15000"
                           aria-valuemax="120000"
                           aria-valuenow="45000"
                           aria-label="Continuous hard cut limit"
                           aria-describedby="continuous-hard-cut-value" />
                    <span id="continuous-hard-cut-value" class="range-value" aria-live="polite">45s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Minimum chunk duration</span>
                  <div class="range-row">
                    <input id="continuous-min-chunk" type="range" min="250" max="5000" step="50"
                           title="Minimum usable chunk duration (seconds)"
                           aria-valuemin="250"
                           aria-valuemax="5000"
                           aria-valuenow="1000"
                           aria-label="Continuous minimum chunk duration"
                           aria-describedby="continuous-min-chunk-value" />
                    <span id="continuous-min-chunk-value" class="range-value" aria-live="polite">1.0s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Pre-roll context</span>
                  <div class="range-row">
                    <input id="continuous-pre-roll" type="range" min="0" max="1500" step="50"
                           title="Audio context added before each segment (seconds)"
                           aria-valuemin="0"
                           aria-valuemax="1500"
                           aria-valuenow="300"
                           aria-label="Continuous pre-roll context"
                           aria-describedby="continuous-pre-roll-value" />
                    <span id="continuous-pre-roll-value" class="range-value" aria-live="polite">0.30s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Post-roll context</span>
                  <div class="range-row">
                    <input id="continuous-post-roll" type="range" min="0" max="1500" step="50"
                           title="Audio context added after each segment (seconds)"
                           aria-valuemin="0"
                           aria-valuemax="1500"
                           aria-valuenow="200"
                           aria-label="Continuous post-roll context"
                           aria-describedby="continuous-post-roll-value" />
                    <span id="continuous-post-roll-value" class="range-value" aria-live="polite">0.20s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">Idle keepalive flush</span>
                  <div class="range-row">
                    <input id="continuous-keepalive" type="range" min="10000" max="120000" step="5000"
                           title="Force a flush after this idle period (seconds)"
                           aria-valuemin="10000"
                           aria-valuemax="120000"
                           aria-valuenow="60000"
                           aria-label="Continuous idle keepalive flush"
                           aria-describedby="continuous-keepalive-value" />
                    <span id="continuous-keepalive-value" class="range-value" aria-live="polite">60s</span>
                  </div>
                </label>
                <div class="field toggle span-2">
                  <label class="toggle-row">
                    <span class="field-label">System Audio override</span>
                    <input id="continuous-system-override-toggle" type="checkbox" title="Use custom timing settings for system audio instead of global defaults" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Use source-specific dump timings for system audio.</span>
                </div>
                <label class="field range span-2">
                  <span class="field-label">System soft flush</span>
                  <div class="range-row">
                    <input id="continuous-system-soft-flush" type="range" min="4000" max="30000" step="500"
                           title="Flush system audio buffer after this silence (seconds)"
                           aria-valuemin="4000"
                           aria-valuemax="30000"
                           aria-valuenow="10000"
                           aria-label="System soft flush"
                           aria-describedby="continuous-system-soft-flush-value" />
                    <span id="continuous-system-soft-flush-value" class="range-value" aria-live="polite">10s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">System silence flush</span>
                  <div class="range-row">
                    <input id="continuous-system-silence-flush" type="range" min="300" max="5000" step="100"
                           title="Force a system audio flush after this silence (seconds)"
                           aria-valuemin="300"
                           aria-valuemax="5000"
                           aria-valuenow="1200"
                           aria-label="System silence flush"
                           aria-describedby="continuous-system-silence-flush-value" />
                    <span id="continuous-system-silence-flush-value" class="range-value" aria-live="polite">1.2s</span>
                  </div>
                </label>
                <label class="field range span-2">
                  <span class="field-label">System hard cut</span>
                  <div class="range-row">
                    <input id="continuous-system-hard-cut" type="range" min="15000" max="120000" step="1000"
                           title="Maximum system audio segment before forced split (seconds)"
                           aria-valuemin="15000"
                           aria-valuemax="120000"
                           aria-valuenow="45000"
                           aria-label="System hard cut"
                           aria-describedby="continuous-system-hard-cut-value" />
                    <span id="continuous-system-hard-cut-value" class="range-value" aria-live="polite">45s</span>
                  </div>
                </label>
              </div>
            </details>
          </div>
          </div>
        </section>

        <section class="panel" data-panel="postprocessing" data-default-collapsed="true" style="--delay: 0.19s">
          <div class="panel-header">
            <div class="panel-title">
              <h2>Post-Processing</h2>
              <p>Enhance transcription quality with intelligent text refinement</p>
            </div>
            <div class="panel-actions">
              <button class="panel-collapse-btn"
                      data-panel-collapse="postprocessing"
                      title="Collapse"
                      aria-expanded="true"
                      aria-controls="postprocessing-panel-body"
                      aria-label="Collapse post-processing panel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body" id="postprocessing-panel-body">
            <div class="panel-grid">

              <!-- Master toggle -->
              <div class="field toggle span-2">
                <label class="toggle-row">
                  <span class="field-label">Enable post-processing</span>
                  <input id="postproc-enabled" type="checkbox" title="Run post-processing rules on every transcript" />
                  <span class="toggle-track"><span class="toggle-thumb"></span></span>
                </label>
                <span class="toggle-hint">Apply intelligent text enhancements to transcriptions</span>
              </div>

              <div id="postproc-settings" class="span-2" style="display: none;">

                <!-- Language -->
                <label class="field">
                  <span class="field-label">Processing language</span>
                  <select id="postproc-language" title="Language used for post-processing rules">
                    <option value="en">English</option>
                    <option value="de">Deutsch (German)</option>
                    <option value="multi">Multilingual (EN/DE)</option>
                  </select>
                  <span class="field-hint">Multilingual mode applies both English and German rules simultaneously</span>
                </label>

                <!-- Rule-based toggles -->
                <div class="field toggle">
                  <label class="toggle-row">
                    <span class="field-label">Punctuation</span>
                    <input id="postproc-punctuation" type="checkbox" title="Automatically add punctuation (periods, commas, question marks)" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Add periods, commas, question marks</span>
                </div>

                <div class="field toggle">
                  <label class="toggle-row">
                    <span class="field-label">Capitalization</span>
                    <input id="postproc-capitalization" type="checkbox" title="Capitalize the first letter of sentences and proper nouns" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Capitalize sentences and proper words</span>
                </div>

                <div class="field toggle">
                  <label class="toggle-row">
                    <span class="field-label">Number normalization</span>
                    <input id="postproc-numbers" type="checkbox" title="Convert written-out numbers to digits (e.g. &quot;three&quot; ‚Üí &quot;3&quot;)" />
                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                  </label>
                  <span class="toggle-hint">Convert number words to digits (e.g., "three" ‚Üí "3")</span>
                </div>

                <!-- Custom Vocabulary -->
                <details class="expander span-2">
                  <summary>Custom Vocabulary</summary>
                  <div class="expander-content">
                    <div class="field toggle">
                      <label class="toggle-row">
                        <span class="field-label">Enable custom vocabulary</span>
                        <input id="postproc-custom-vocab-enabled" type="checkbox" title="Apply custom find-and-replace rules to every transcript" />
                        <span class="toggle-track"><span class="toggle-thumb"></span></span>
                      </label>
                      <span class="toggle-hint">Replace specific words or phrases</span>
                    </div>
                    <div id="postproc-custom-vocab-config" style="display: none;">
                      <p class="field-hint" style="margin-bottom: 10px;">
                        Define word replacements with word boundary matching.
                        <span style="opacity: 0.7;">Example: <code style="font-size: 11px; padding: 2px 5px; background: rgba(255,255,255,0.05); border-radius: 3px;">api</code> ‚Üí <code style="font-size: 11px; padding: 2px 5px; background: rgba(255,255,255,0.05); border-radius: 3px;">API</code></span>
                      </p>
                      <div class="custom-vocab-table">
                        <div class="vocab-header">
                          <span>Match Word</span>
                          <span>Replace With</span>
                          <span aria-label="Actions"></span>
                        </div>
                        <div id="postproc-vocab-rows">
                          <!-- Dynamically populated -->
                        </div>
                      </div>
                      <button id="postproc-vocab-add" class="btn-secondary" title="Add a new find-and-replace entry" style="margin-top: 10px; font-size: 13px; font-weight: 600;">
                        <span style="font-size: 16px; margin-right: 4px; line-height: 1;">+</span> Add Entry
                      </button>
                    </div>
                  </div>
                </details>
                <div class="field span-2">
                  <span class="field-hint">AI-powered refinement is configured in the
                    <button type="button" class="link-btn" id="go-to-ai-refinement">AI Refinement tab ‚Üí</button>
                  </span>
                </div>

              </div>
            </div>
          </div>
        </section>

        <section class="panel transcription-panel" data-panel="model" data-default-collapsed="true" style="--delay: 0.18s">
          <div class="panel-header">
            <div class="panel-title">
              <h2>Whisper Model Manager</h2>
              <p>Download and manage local whisper.cpp models.</p>
            </div>
            <div class="panel-actions">
              <button class="panel-collapse-btn"
                      data-panel-collapse="model"
                      title="Collapse"
                      aria-expanded="true"
                      aria-controls="model-panel-body"
                      aria-label="Collapse model manager panel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body" id="model-panel-body">
          <div class="model-manager">
            <div class="panel-grid model-source-grid">
              <label class="field">
                <span class="field-label">Source</span>
                <select id="model-source-select" title="Where to load the Whisper model from">
                  <option value="default">Default (whisper.cpp)</option>
                  <option value="custom">Custom URL</option>
                </select>
              </label>
              <label class="field span-2" id="model-custom-url-field">
                <span class="field-label">Custom model URL</span>
                <div class="hotkey-input-group">
                  <input
                    id="model-custom-url"
                    type="text"
                    placeholder="https://example.com/models.json or model.bin"
                    title="URL to a Whisper model file or JSON model index"
                  />
                  <button id="model-refresh" class="hotkey-record-btn" title="Scan for downloaded models">Refresh</button>
                </div>
                <span class="field-hint">Supports JSON index or direct model file URL.</span>
              </label>
            </div>
            <div class="panel-grid model-storage-grid">
              <label class="field span-2">
                <span class="field-label">Model storage</span>
                <div class="hotkey-input-group">
                  <input
                    id="model-storage-path"
                    type="text"
                    placeholder="Default (App data/models)"
                    title="Folder where downloaded models are stored"
                  />
                  <button id="model-storage-browse" class="hotkey-record-btn" title="Choose a folder for storing models">Browse</button>
                  <button id="model-storage-reset" class="hotkey-record-btn" title="Reset model storage path to default">Reset</button>
                </div>
                <span class="field-hint">Choose where downloaded models are stored.</span>
              </label>
            </div>
            <div class="model-section">
              <div class="model-section-title">Models</div>
              <div id="model-list" class="model-list"></div>
              <p class="model-hint">Active models use the teal border. Available models are dimmed.</p>
            </div>
          </div>
          </div>
        </section>

        <section class="panel interface-panel" data-panel="interface" data-default-collapsed="true" style="--delay: 0.22s">
          <div class="panel-header">
            <div class="panel-title">
              <h2>UX / UI-Adjustments</h2>
              <p>Overlay, layout, and visual feedback settings.</p>
            </div>
            <div class="panel-actions">
              <button class="panel-collapse-btn"
                      data-panel-collapse="interface"
                      title="Collapse"
                      aria-expanded="true"
                      aria-controls="interface-panel-body"
                      aria-label="Collapse UI adjustments panel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body" id="interface-panel-body">
          <div class="panel-grid">
            <div class="field hotkey-field span-2">
              <span class="field-label">Toggle activation words</span>
              <div class="hotkey-input-group">
                <input id="toggle-activation-words-hotkey" type="text" readonly title="Current hotkey for toggling activation words ‚Äî click Record to change" />
                <button id="toggle-activation-words-hotkey-record" class="hotkey-record-btn" title="Click to record hotkey">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" />
                  </svg>
                  Record
                </button>
              </div>
              <span id="toggle-activation-words-hotkey-status" class="hotkey-status"
                    role="status"
                    aria-live="polite"></span>
            </div>
          </div>
          <details class="expander">
            <summary>Overlay</summary>
            <div class="expander-body">
              <label class="field">
                <span class="field-label">Style</span>
                <select id="overlay-style" title="Visual style for the recording overlay">
                  <option value="dot">HAL 9000 by Space:2001¬Æ</option>
                  <option value="kitt">KITT by Dox¬Æ</option>
                </select>
              </label>
              <label class="field">
                <span class="field-label">Color</span>
                <input id="overlay-color" type="color" title="Accent color for the recording overlay" />
              </label>
              <!-- Dot mode settings -->
              <div id="overlay-dot-settings" class="settings-grid-2col">
              <label class="field range">
                <span class="field-label">Min radius (px)</span>
                <div class="range-row">
                  <input id="overlay-min-radius" type="range" min="4" max="32" step="1"
                         title="Smallest dot size on the recording overlay"
                         aria-valuemin="4"
                         aria-valuemax="32"
                         aria-valuenow="8"
                         aria-label="Overlay dot minimum radius"
                         aria-describedby="overlay-min-radius-value" />
                  <span id="overlay-min-radius-value" class="range-value" aria-live="polite">8</span>
                </div>
              </label>
              <label class="field range">
                <span class="field-label">Max radius (px)</span>
                <div class="range-row">
                  <input id="overlay-max-radius" type="range" min="8" max="64" step="1"
                         title="Largest dot size on the recording overlay"
                         aria-valuemin="8"
                         aria-valuemax="64"
                         aria-valuenow="24"
                         aria-label="Overlay dot maximum radius"
                         aria-describedby="overlay-max-radius-value" />
                  <span id="overlay-max-radius-value" class="range-value" aria-live="polite">24</span>
                </div>
              </label>
              </div>
              <!-- KITT mode settings -->
              <div id="overlay-kitt-settings" class="settings-grid-2col" style="display: none;">
              <label class="field range">
                <span class="field-label">Min width (px)</span>
                <div class="range-row">
                  <input id="overlay-kitt-min-width" type="range" min="4" max="40" step="1"
                         title="Minimum bar width for the KITT overlay style"
                         aria-valuemin="4"
                         aria-valuemax="40"
                         aria-valuenow="20"
                         aria-label="Overlay KITT bar minimum width"
                         aria-describedby="overlay-kitt-min-width-value" />
                  <span id="overlay-kitt-min-width-value" class="range-value" aria-live="polite">20</span>
                </div>
              </label>
              <label class="field range">
                <span class="field-label">Max width (px)</span>
                <div class="range-row">
                  <input id="overlay-kitt-max-width" type="range" min="50" max="800" step="10"
                         title="Maximum bar width for the KITT overlay style"
                         aria-valuemin="50"
                         aria-valuemax="800"
                         aria-valuenow="200"
                         aria-label="Overlay KITT bar maximum width"
                         aria-describedby="overlay-kitt-max-width-value" />
                  <span id="overlay-kitt-max-width-value" class="range-value" aria-live="polite">200</span>
                </div>
              </label>
              <label class="field range span-2">
                <span class="field-label">Height (px)</span>
                <div class="range-row">
                  <input id="overlay-kitt-height" type="range" min="8" max="40" step="1"
                         title="Bar height for the KITT overlay style"
                         aria-valuemin="8"
                         aria-valuemax="40"
                         aria-valuenow="20"
                         aria-label="Overlay KITT bar height"
                         aria-describedby="overlay-kitt-height-value" />
                  <span id="overlay-kitt-height-value" class="range-value" aria-live="polite">20</span>
                </div>
              </label>
              </div>
              <!-- Shared settings -->
              <div class="settings-grid-2col">
              <label class="field range">
                <span class="field-label">Rise smoothing (ms)</span>
                <div class="range-row">
                  <input id="overlay-rise" type="range" min="20" max="600" step="10"
                         title="How fast the overlay reacts to rising audio (ms)"
                         aria-valuemin="20"
                         aria-valuemax="600"
                         aria-valuenow="80"
                         aria-label="Overlay animation rise smoothing"
                         aria-describedby="overlay-rise-value" />
                  <span id="overlay-rise-value" class="range-value" aria-live="polite">80</span>
                </div>
              </label>
              <label class="field range">
                <span class="field-label">Fall smoothing (ms)</span>
                <div class="range-row">
                  <input id="overlay-fall" type="range" min="20" max="800" step="10"
                         title="How fast the overlay fades after audio drops (ms)"
                         aria-valuemin="20"
                         aria-valuemax="800"
                         aria-valuenow="160"
                         aria-label="Overlay animation fall smoothing"
                         aria-describedby="overlay-fall-value" />
                  <span id="overlay-fall-value" class="range-value" aria-live="polite">160</span>
                </div>
              </label>
              <label class="field range">
                <span class="field-label">Inactive opacity</span>
                <div class="range-row">
                  <input id="overlay-opacity-inactive" type="range" min="5" max="100" step="1"
                         title="Overlay opacity when not recording"
                         aria-valuemin="5"
                         aria-valuemax="100"
                         aria-valuenow="20"
                         aria-label="Overlay inactive opacity"
                         aria-describedby="overlay-opacity-inactive-value" />
                  <span id="overlay-opacity-inactive-value" class="range-value" aria-live="polite">20%</span>
                </div>
              </label>
              <label class="field range">
                <span class="field-label">Active opacity</span>
                <div class="range-row">
                  <input id="overlay-opacity-active" type="range" min="5" max="100" step="1"
                         title="Overlay opacity while recording"
                         aria-valuemin="5"
                         aria-valuemax="100"
                         aria-valuenow="80"
                         aria-label="Overlay active opacity"
                         aria-describedby="overlay-opacity-active-value" />
                  <span id="overlay-opacity-active-value" class="range-value" aria-live="polite">80%</span>
                </div>
              </label>
              </div>
              <div class="panel-grid">
                <label class="field">
                  <span class="field-label">Position X (%)</span>
                  <input id="overlay-pos-x" type="number" min="0" max="100" step="1"
                         title="Horizontal overlay position (0 = left, 100 = right)" />
                </label>
                <label class="field">
                  <span class="field-label">Position Y (%)</span>
                  <input id="overlay-pos-y" type="number" min="0" max="100" step="1"
                         title="Vertical overlay position (0 = top, 100 = bottom)" />
                </label>
              </div>
              <button id="apply-overlay-btn" class="button primary" title="Apply overlay position and style settings" style="margin-top: 12px; width: 100%;">Apply Overlay Settings</button>
            </div>
          </details>
          <details class="expander">
            <summary>Chapters</summary>
            <div class="expander-body">
              <div class="field toggle">
                <label class="toggle-row">
                  <span class="field-label">Enable chapters</span>
                  <input id="chapters-enabled" type="checkbox" title="Automatically add chapter markers to long transcripts" />
                  <span class="toggle-track"><span class="toggle-thumb"></span></span>
                </label>
                <span class="toggle-hint">Show chapter markers in long transcripts</span>
              </div>
              <div id="chapters-settings" style="display: none;">
                <label class="field">
                  <span class="field-label">Show chapters in</span>
                  <select id="chapters-show-in" title="Panel where chapter markers are displayed">
                    <option value="conversation">Conversation tab only</option>
                    <option value="all">All tabs</option>
                  </select>
                  <span class="field-hint">Conversation mode recommended for meetings and lectures</span>
                </label>
                <label class="field">
                  <span class="field-label">Chapter generation method</span>
                  <select id="chapters-method" title="Algorithm used to detect chapter boundaries">
                    <option value="silence">Silence-based</option>
                    <option value="time">Time-based (5min)</option>
                    <option value="hybrid">Hybrid (recommended)</option>
                  </select>
                  <span class="field-hint">Hybrid combines silence detection with time-based fallback</span>
                </label>
              </div>
            </div>
          </details>
          </div>
        </section>
        </div>

        <!-- AI Refinement Tab -->
        <div id="tab-ai-refinement" class="main-tab-content" role="tabpanel" aria-labelledby="tab-btn-ai-refinement">
          <section class="panel ai-refine-panel" data-panel="ai-refinement" style="--delay: 0.12s">
            <div class="panel-header">
              <div class="panel-title">
                <h2>AI Refinement</h2>
                <p>AI-powered transcript improvement, topic detection, and adaptive vocabulary</p>
              </div>
            </div>
            <div class="panel-body" id="ai-refinement-panel-body">

              <!-- Master Toggle ‚Äî always visible, outside expanders -->
              <div class="field toggle ai-refine-master-toggle">
                <label class="toggle-row">
                  <span class="field-label">Enable AI refinement</span>
                  <input id="ai-fallback-enabled" type="checkbox" title="Send transcripts to an AI provider for refinement and correction" />
                  <span class="toggle-track"><span class="toggle-thumb"></span></span>
                </label>
                <span class="toggle-hint">Apply provider-based refinement after local post-processing rules</span>
              </div>

              <!-- Runtime & Provider Setup -->
              <div class="ai-refine-section">
                <details id="ai-refinement-runtime-expander" class="expander ai-refine-expander" open>
                  <summary>
                    <h3 id="ai-refinement-provider-model-title" class="ai-refine-section-title">Runtime &amp; Provider</h3>
                  </summary>
                  <div class="expander-body">
                    <div id="ai-fallback-settings" class="panel-grid span-2">

                      <div id="ai-fallback-provider-lanes" class="ai-provider-lanes span-2">
                        <div id="ai-fallback-local-lane" data-lane="local" class="ai-provider-lane ai-provider-lane--local" role="button" tabindex="0" aria-pressed="true">
                          <div class="ai-provider-lane-header">
                            <span id="ai-fallback-local-lane-title" class="field-label">Primary Runtime</span>
                            <span class="badge">Offline ‚Ä¢ Private</span>
                          </div>
                          <div class="ai-provider-lane-title">Ollama (Local)</div>
                          <span id="ai-fallback-local-primary-status" class="field-hint">
                            Checking local runtime status...
                          </span>
                          <div class="ai-provider-lane-actions">
                            <button id="ai-fallback-local-primary-action" class="hotkey-record-btn is-recommended" type="button" title="Install or start local Ollama runtime">
                              Install local runtime
                            </button>
                            <button id="ai-fallback-local-import-action" class="hotkey-record-btn" type="button" title="Import a local GGUF or Modelfile into Ollama">
                              Import model
                            </button>
                          </div>
                          <details id="ai-fallback-local-advanced" class="ai-provider-advanced">
                            <summary>Advanced runtime tools</summary>
                            <div class="ai-provider-advanced-actions">
                              <button id="ai-fallback-local-detect-action" class="hotkey-record-btn" type="button" title="Scan for local/runtime PATH installation">
                                Detect
                              </button>
                              <button id="ai-fallback-local-use-system-action" class="hotkey-record-btn" type="button" title="Use Ollama from system PATH">
                                Use system
                              </button>
                              <button id="ai-fallback-local-verify-action" class="hotkey-record-btn" type="button" title="Verify local runtime health and models">
                                Verify
                              </button>
                              <button id="ai-fallback-local-refresh-action" class="hotkey-record-btn" type="button" title="Refresh runtime and model status">
                                Refresh
                              </button>
                            </div>
                          </details>
                          <span id="ai-fallback-local-runtime-note" class="field-hint">
                            Local mode keeps transcript data on this device.
                          </span>
                        </div>

                        <div id="ai-fallback-online-lane" data-lane="online" class="ai-provider-lane ai-provider-lane--online" role="button" tabindex="0" aria-pressed="false">
                          <div class="ai-provider-lane-header">
                            <span id="ai-fallback-online-lane-title" class="field-label">Online Fallback (Optional)</span>
                            <span id="ai-fallback-online-status-badge" class="badge badge--online is-locked">Online ‚Ä¢ Locked</span>
                          </div>
                          <div class="field">
                            <span class="field-label">Cloud providers</span>
                            <div id="ai-fallback-cloud-provider-list" class="cloud-provider-list"></div>
                          </div>
                          <span id="ai-fallback-fallback-status" class="field-hint">
                            Save and verify credentials to unlock cloud fallback providers.
                          </span>
                        </div>
                      </div>

                      <label id="ai-fallback-model-field" class="field">
                        <span class="field-label">Online model</span>
                        <select id="ai-fallback-model" title="Model to use for refinement (loaded from selected provider)"></select>
                      </label>

                      <div id="ai-fallback-ollama-managed-note" class="field-hint span-2" style="display:none;">
                        Ollama model selection is managed in the model cards below.
                      </div>

                    </div>
                  </div>
                </details>
              </div>

              <!-- Refinement Quality ‚Äî collapsed by default -->
              <div class="ai-refine-section">
                <details class="expander ai-refine-expander">
                  <summary>
                    <h3 class="ai-refine-section-title">Refinement Quality</h3>
                  </summary>
                  <div class="expander-body">
                    <div class="panel-grid">

                      <label class="field range">
                        <span class="field-label">Temperature</span>
                        <div class="range-row">
                          <input id="ai-fallback-temperature" type="range" min="0" max="1" step="0.05"
                                 title="AI creativity level ‚Äî lower = more literal, higher = more creative"
                                 aria-valuemin="0"
                                 aria-valuemax="1"
                                 aria-valuenow="0.3"
                                 aria-label="AI fallback temperature"
                                 aria-describedby="ai-fallback-temperature-value" />
                          <span id="ai-fallback-temperature-value" class="range-value" aria-live="polite">0.30</span>
                        </div>
                      </label>

                      <label class="field">
                        <span class="field-label">Max tokens</span>
                        <select id="ai-fallback-max-tokens" title="Maximum number of tokens the AI can output per refinement">
                          <option value="512">512</option>
                          <option value="1024">1024</option>
                          <option value="2048">2048</option>
                          <option value="4000">4000</option>
                          <option value="8192">8192</option>
                        </select>
                      </label>

                      <div class="field toggle span-2">
                        <label class="toggle-row">
                          <span class="field-label">Use custom prompt</span>
                          <input id="ai-fallback-custom-prompt-enabled" type="checkbox" title="Replace the built-in refinement prompt with a custom one" />
                          <span class="toggle-track"><span class="toggle-thumb"></span></span>
                        </label>
                        <span class="toggle-hint">Override default refinement prompt for this profile</span>
                      </div>

                      <div id="ai-fallback-custom-prompt-field" class="field span-2" style="display: none;">
                        <span class="field-label">Custom prompt</span>
                        <textarea id="ai-fallback-custom-prompt" rows="4" placeholder="Refine this transcript ..."
                                  title="Custom prompt sent to the AI before each transcript"></textarea>
                      </div>

                    </div>
                  </div>
                </details>
              </div>

              <!-- Models -->
              <div class="ai-refine-section">
                <details id="ai-refinement-models-expander" class="expander ai-refine-expander" open>
                  <summary>
                    <h3 id="ai-refinement-models-title" class="ai-refine-section-title">Models</h3>
                  </summary>
                  <div class="expander-body">
                    <div id="ollama-model-manager" style="display:none">
                      <!-- Dynamically populated by renderOllamaModelManager() -->
                    </div>
                  </div>
                </details>
              </div>

              <!-- Topic Detection -->
              <div class="ai-refine-section">
                <details id="ai-refinement-topic-expander" class="expander ai-refine-topic-expander">
                  <summary>
                    <span id="ai-refinement-topic-title" class="ai-refine-section-title">Topic Detection</span>
                  </summary>
                  <div class="expander-body">
                    <div id="topic-keywords-list"></div>
                    <button id="topic-keywords-reset" class="btn-secondary" title="Reset topic keywords to built-in defaults" style="width: 100%; margin-top: 8px;">
                      Reset to Defaults
                    </button>
                    <span class="field-hint" style="display: block; margin-top: 8px;">
                      Customize keywords for automatic topic detection. Topics are shown as badges on conversation entries.
                    </span>
                  </div>
                </details>
              </div>

            </div>
          </section>
        </div>

      </div>
    </main>

    <div id="ai-auth-modal" class="auth-modal" hidden>
      <div id="ai-auth-modal-backdrop" class="auth-modal-backdrop"></div>
      <div class="auth-modal-card" role="dialog" aria-modal="true" aria-labelledby="ai-auth-modal-title">
        <div class="auth-modal-header">
          <h3 id="ai-auth-modal-title" class="ai-refine-section-title">Authenticate Provider</h3>
          <button id="ai-auth-modal-close" type="button" class="hotkey-record-btn">Close</button>
        </div>
        <p id="ai-auth-provider-name" class="field-hint">Provider</p>
        <label class="field">
          <span class="field-label">Authentication method</span>
          <select id="ai-auth-method" title="Select cloud authentication method">
            <option value="api_key">API key</option>
            <option value="oauth" disabled>OAuth (coming soon)</option>
          </select>
        </label>
        <label class="field">
          <span class="field-label">API key</span>
          <input id="ai-auth-api-key-input" type="password" placeholder="Paste provider API key" title="API key for the selected cloud provider" />
        </label>
        <div class="auth-modal-actions">
          <button id="ai-auth-save-key" class="hotkey-record-btn" type="button">Save key</button>
          <button id="ai-auth-clear-key" class="hotkey-record-btn" type="button">Clear key</button>
          <button id="ai-auth-verify-key" class="hotkey-record-btn" type="button">Verify</button>
        </div>
        <span id="ai-auth-status" class="field-hint">No API key stored.</span>
      </div>
    </div>
  </body>
</html>
